<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- MSAL Library for automated login -->
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        /** üîê CONFIGURATION
         * 1. Paste your Client ID from Azure below.
         * 2. The Site ID and List ID are already set from your previous message.
         */
        const CONFIG_DATA = {
            clientId: "<e284416c-ae2d-43f7-9f0f-f251aef8c86a>", 
            authority: "https://login.microsoftonline.com/common",
            siteId: "teamholiday.sharepoint.com,99f0de2d-fe8e-4a4d-b84b-c11f0f222d3f", 
            listId: "fcb9fcde-8bef-43d7-8bab-6800a7401599", 
            statusColumn: "Status", 
            descriptionColumn: "Description"
        };

        const msalConfig = {
            auth: {
                clientId: CONFIG_DATA.clientId,
                authority: CONFIG_DATA.authority,
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: {
                cacheLocation: "sessionStorage"
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "Sites.ReadWrite.All"]
        };

        const App = () => {
            const [msalInstance, setMsalInstance] = useState(null);
            const [account, setAccount] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [updatingId, setUpdatingId] = useState(null);

            // Initialize MSAL on load
            useEffect(() => {
                const pca = new msal.PublicClientApplication(msalConfig);
                setMsalInstance(pca);
                
                const accounts = pca.getAllAccounts();
                if (accounts.length > 0) {
                    setAccount(accounts[0]);
                }
            }, []);

            const handleLogin = async () => {
                try {
                    const response = await msalInstance.loginPopup(loginRequest);
                    setAccount(response.account);
                } catch (err) {
                    console.error(err);
                    setError("Login failed. Check if popups are blocked.");
                }
            };

            const handleLogout = () => {
                msalInstance.logoutPopup();
                setAccount(null);
                setTasks([]);
            };

            const getAccessToken = async () => {
                const request = {
                    ...loginRequest,
                    account: account
                };
                try {
                    const response = await msalInstance.acquireTokenSilent(request);
                    return response.accessToken;
                } catch (e) {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                }
            };

            const fetchTasks = async () => {
                if (!account) return;

                setLoading(true);
                setError(null);
                try {
                    const token = await getAccessToken();
                    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG_DATA.siteId}/lists/${CONFIG_DATA.listId}/items?expand=fields($select=id,Title,${CONFIG_DATA.statusColumn},${CONFIG_DATA.descriptionColumn},Created,Modified)`;
                    
                    const response = await fetch(url, {
                        headers: { 
                            Authorization: `Bearer ${token}`,
                            "Accept": "application/json"
                        }
                    });

                    if (!response.ok) throw new Error("Failed to fetch data from SharePoint.");

                    const data = await response.json();
                    setTasks(data.value || []);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const updateTaskStatus = async (itemId, newStatus) => {
                setUpdatingId(itemId);
                try {
                    const token = await getAccessToken();
                    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG_DATA.siteId}/lists/${CONFIG_DATA.listId}/items/${itemId}/fields`;
                    
                    const response = await fetch(url, {
                        method: "PATCH",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ [CONFIG_DATA.statusColumn]: newStatus })
                    });
                    
                    if (!response.ok) throw new Error("Update failed.");
                    
                    setTasks(prev => prev.map(t => t.id === itemId ? { 
                        ...t, 
                        fields: { ...t.fields, [CONFIG_DATA.statusColumn]: newStatus, Modified: new Date().toISOString() } 
                    } : t));
                } catch (err) {
                    alert(err.message);
                } finally {
                    setUpdatingId(null);
                }
            };

            useEffect(() => {
                if (account) fetchTasks();
            }, [account]);

            const filteredTasks = useMemo(() => 
                tasks.filter(t => t.fields.Title.toLowerCase().includes(searchQuery.toLowerCase())), 
            [tasks, searchQuery]);

            const getStatusStyle = (status) => {
                switch (status) {
                    case "Actioned": return "bg-green-50 text-green-700 border-green-200";
                    case "In Progress": return "bg-amber-50 text-amber-700 border-amber-200";
                    case "On Hold": return "bg-gray-100 text-gray-600 border-gray-200";
                    default: return "bg-blue-50 text-blue-700 border-blue-200";
                }
            };

            if (!account) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-slate-100">
                            <div className="bg-[#1a2333] w-16 h-16 rounded-2xl flex items-center justify-center text-white mx-auto mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Task Tracker</h2>
                            <p className="text-slate-500 mb-8">Sign in with your work account to manage Staffing Team requests.</p>
                            <button 
                                onClick={handleLogin}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-all shadow-md"
                            >
                                Sign In
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 text-slate-900">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-[#1a2333] p-2 rounded-lg text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-[#1a2333]">Task Tracker</h1>
                                    <p className="text-xs text-slate-400">Signed in as {account.username}</p>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="text-xs text-red-500 font-medium bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm hover:bg-red-50">
                                Sign Out
                            </button>
                        </div>

                        <div className="relative mb-6">
                             <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            </div>
                            <input 
                                type="text" 
                                placeholder="Search tasks..." 
                                className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                                value={searchQuery} 
                                onChange={(e) => setSearchQuery(e.target.value)} 
                            />
                        </div>

                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                                <div className="animate-spin mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                </div>
                                <p>Loading Staffing Team data...</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {filteredTasks.length === 0 && (
                                    <div className="text-center py-20 bg-white rounded-xl border border-dashed border-slate-200 text-slate-400">
                                        No tasks found.
                                    </div>
                                )}
                                {filteredTasks.map(task => (
                                    <div key={task.id} className="bg-white border border-slate-100 rounded-xl p-6 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4 transition-all hover:shadow-md">
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-slate-800 mb-1">{task.fields.Title}</h3>
                                            <p className="text-slate-500 text-sm mb-2">{task.fields[CONFIG_DATA.descriptionColumn]}</p>
                                            <div className="flex gap-4 text-[10px] text-slate-400 font-medium uppercase tracking-wider">
                                                <span>Created: {new Date(task.fields.Created).toLocaleDateString()}</span>
                                                <span>Modified: {new Date(task.fields.Modified).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            {updatingId === task.id && (
                                                <div className="animate-spin text-indigo-500">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                                </div>
                                            )}
                                            <select 
                                                className={`px-4 py-1.5 rounded-lg border text-sm font-medium cursor-pointer focus:outline-none transition-colors ${getStatusStyle(task.fields[CONFIG_DATA.statusColumn])}`} 
                                                value={task.fields[CONFIG_DATA.statusColumn]} 
                                                disabled={updatingId === task.id}
                                                onChange={(e) => updateTaskStatus(task.id, e.target.value)}
                                            >
                                                <option value="New">New</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Actioned">Actioned</option>
                                                <option value="On Hold">On Hold</option>
                                            </select>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {error && (
                            <div className="mt-8 p-4 bg-red-50 border border-red-100 text-red-700 rounded-lg text-sm">
                                <strong>Error:</strong> {error}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
