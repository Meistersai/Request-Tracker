<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        /** ðŸ” CONFIGURATION
         * Update these values for your live deployment.
         */
        const CONFIG_DATA = {
            siteId: "teamholiday.sharepoint.com,99f0de2d-fe8e-4a4d-b84b-c11f0f222d3f", 
            listId: "fcb9fcde-8bef-43d7-8bab-6800a7401599", 
            statusColumn: "Status", 
            descriptionColumn: "Description",
            accessToken: "" 
        };

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [updatingId, setUpdatingId] = useState(null);
            const [token, setToken] = useState(CONFIG_DATA.accessToken);
            const [showTokenInput, setShowTokenInput] = useState(!CONFIG_DATA.accessToken);

            const fetchTasks = async (overrideToken) => {
                const activeToken = overrideToken || token;
                if (!activeToken) {
                    setError("Access token is missing. Please provide a token.");
                    setTasks(getMockData());
                    return;
                }

                setLoading(true);
                setError(null);
                try {
                    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG_DATA.siteId}/lists/${CONFIG_DATA.listId}/items?expand=fields($select=id,Title,${CONFIG_DATA.statusColumn},${CONFIG_DATA.descriptionColumn},Created,Modified)`;
                    const response = await fetch(url, {
                        headers: { 
                            Authorization: `Bearer ${activeToken}`,
                            "Accept": "application/json"
                        }
                    });

                    if (!response.ok) throw new Error("Connection failed. Check your token.");

                    const data = await response.json();
                    setTasks(data.value || []);
                    setShowTokenInput(false);
                } catch (err) {
                    setError(err.message);
                    setTasks(getMockData());
                } finally {
                    setLoading(false);
                }
            };

            const updateTaskStatus = async (itemId, newStatus) => {
                setUpdatingId(itemId);
                try {
                    const url = `https://graph.microsoft.com/v1.0/sites/${CONFIG_DATA.siteId}/lists/${CONFIG_DATA.listId}/items/${itemId}/fields`;
                    const response = await fetch(url, {
                        method: "PATCH",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ [CONFIG_DATA.statusColumn]: newStatus })
                    });
                    if (!response.ok) throw new Error("Update failed.");
                    setTasks(prev => prev.map(t => t.id === itemId ? { ...t, fields: { ...t.fields, [CONFIG_DATA.statusColumn]: newStatus, Modified: new Date().toISOString() } } : t));
                } catch (err) {
                    alert(err.message);
                } finally {
                    setUpdatingId(null);
                }
            };

            useEffect(() => { fetchTasks(); }, []);

            const filteredTasks = useMemo(() => tasks.filter(t => t.fields.Title.toLowerCase().includes(searchQuery.toLowerCase())), [tasks, searchQuery]);

            const getStatusStyle = (status) => {
                switch (status) {
                    case "Actioned": return "bg-green-50 text-green-700 border-green-200";
                    case "In Progress": return "bg-amber-50 text-amber-700 border-amber-200";
                    case "On Hold": return "bg-gray-100 text-gray-600 border-gray-200";
                    default: return "bg-blue-50 text-blue-700 border-blue-200";
                }
            };

            const getMockData = () => [
                { id: "1", fields: { id: "1", Title: "Sample: Review Q1 Budget", [CONFIG_DATA.statusColumn]: "In Progress", [CONFIG_DATA.descriptionColumn]: "Connect to see real data.", Created: new Date().toISOString(), Modified: new Date().toISOString() } },
                { id: "2", fields: { id: "2", Title: "Sample: Team Meeting", [CONFIG_DATA.statusColumn]: "Actioned", [CONFIG_DATA.descriptionColumn]: "Sync with department heads.", Created: new Date().toISOString(), Modified: new Date().toISOString() } },
            ];

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 text-slate-900">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-3">
                                <div className="bg-[#1a2333] p-2 rounded-lg text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>
                                </div>
                                <h1 className="text-2xl font-bold text-[#1a2333]">Task Tracker</h1>
                            </div>
                            <button onClick={() => setShowTokenInput(!showTokenInput)} className="text-xs text-indigo-600 font-medium bg-white px-3 py-1.5 rounded-md border border-slate-200 shadow-sm">
                                {token ? "Update Token" : "Provide Token"}
                            </button>
                        </div>

                        {showTokenInput && (
                            <div className="mb-8 p-6 bg-white border border-indigo-100 rounded-xl shadow-sm border-l-4 border-l-indigo-500">
                                <p className="text-xs text-slate-500 mb-4">Paste your token from Graph Explorer below.</p>
                                <form onSubmit={(e) => { e.preventDefault(); fetchTasks(); }} className="flex gap-2">
                                    <input type="password" placeholder="Paste Token..." className="flex-1 px-4 py-2 text-sm border border-slate-200 rounded-lg outline-none" value={token} onChange={(e) => setToken(e.target.value)} />
                                    <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">Connect</button>
                                </form>
                            </div>
                        )}

                        <input type="text" placeholder="Search by title..." className="w-full pl-4 pr-4 py-3 bg-white border border-slate-200 rounded-lg shadow-sm mb-6 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />

                        <div className="space-y-4">
                            {filteredTasks.map(task => (
                                <div key={task.id} className="bg-white border border-slate-100 rounded-xl p-6 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold text-slate-800 mb-1">{task.fields.Title}</h3>
                                        <p className="text-slate-500 text-sm">{task.fields[CONFIG_DATA.descriptionColumn]}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <select className={`px-4 py-1.5 rounded-lg border text-sm font-medium ${getStatusStyle(task.fields[CONFIG_DATA.statusColumn])}`} value={task.fields[CONFIG_DATA.statusColumn]} onChange={(e) => updateTaskStatus(task.id, e.target.value)}>
                                            <option value="New">New</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Actioned">Actioned</option>
                                            <option value="On Hold">On Hold</option>
                                        </select>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
